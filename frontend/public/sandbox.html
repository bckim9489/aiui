<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>AI UI Sandbox</title>
    <style>
      :root {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: #fafafa;
      }
      #root {
        min-height: 100vh;
        display: flex;
        align-items: stretch;
        justify-content: center;
      }
      .placeholder {
        margin: auto;
        color: #667085;
        text-align: center;
        padding: 2rem;
      }
      .error {
        color: #d92d20;
      }
      button,
      input,
      select {
        font: inherit;
      }
      table {
        border-collapse: collapse;
      }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react-jsx-runtime.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.26.2/babel.min.js"></script>
  </head>
  <body>
    <div id="root">
      <div class="placeholder">생성된 UI가 여기에 표시됩니다.</div>
    </div>
    <script>
      ;(() => {
        const rootElement = document.getElementById('root')
        let reactRoot = null

        const ReactJSXRuntime = window.ReactJSXRuntime

        const renderPlaceholder = (message, className = 'placeholder') => {
          if (reactRoot) {
            reactRoot.unmount()
            reactRoot = null
          }
          rootElement.innerHTML = ''
          const placeholder = document.createElement('div')
          placeholder.className = className
          placeholder.textContent = message
          rootElement.appendChild(placeholder)
        }

        const createApi = () => ({
          get: (url) =>
            fetch(url).then((response) => {
              if (!response.ok) {
                throw new Error('API 요청 실패')
              }
              return response.json()
            }),
          post: (url, body) =>
            fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body ?? {})
            }).then((response) => {
              if (!response.ok) {
                throw new Error('API 요청 실패')
              }
              return response.json().catch(() => ({}))
            })
        })

        const runCode = (code) => {
          if (!code) {
            renderPlaceholder('전달된 코드가 없습니다.')
            return
          }

          try {
            const compiled = Babel.transform(code, {
              presets: ['react', 'typescript'],
              plugins: ['transform-modules-commonjs'],
              sourceType: 'module'
            }).code

            const module = { exports: {} }
            const require = (specifier) => {
              switch (specifier) {
                case 'react':
                  return React
                case 'react/jsx-runtime':
                  return ReactJSXRuntime
                default:
                  throw new Error(`지원하지 않는 모듈입니다: ${specifier}`)
              }
            }

            const executor = new Function('require', 'module', 'exports', compiled)
            executor(require, module, module.exports)
            const exported = module.exports?.default ?? module.exports

            if (typeof exported !== 'function') {
              throw new Error('React 컴포넌트를 찾을 수 없습니다.')
            }

            const api = createApi()
            if (reactRoot) {
              reactRoot.unmount()
            }
            reactRoot = ReactDOM.createRoot(rootElement)
            reactRoot.render(React.createElement(exported, { api }))
          } catch (error) {
            console.error(error)
            const message =
              (error && error.message) || '코드를 실행하는 중 오류가 발생했습니다.'
            renderPlaceholder(message, 'placeholder error')
          }
        }

        window.addEventListener('message', (event) => {
          const { type, code } = event.data || {}
          if (type !== 'run-code') {
            return
          }
          runCode(code)
        })
      })()
    </script>
  </body>
</html>
